const eventAttr={onclick:1,ondblclick:1,onmousedown:1,onmousemove:1,onmouseout:1,onmouseover:1,onmouseup:1,onwheel:1,onblur:1,onchange:1,oncontextmenu:1,onfocus:1,oninput:1,oninvalid:1,onreset:1,onsearch:1,onselect:1,onsubmit:1,onkeydown:1,onkeypress:1,onkeyup:1,ondrag:1,ondragend:1,ondragenter:1,ondragleave:1,ondragover:1,ondragstart:1,ondrop:1,onscroll:1,oncopy:1,oncut:1,onpaste:1};export class CuppaComponent extends HTMLElement{constructor(){super(),this.cuppa=null,this.pure=!1,this.shadow=!1,this.getDataDictionary={},this.state={},this.refs={},this.parser=new DOMParser}connectedCallback(){!0===this.shadow&&(this.shadow="open"),this.shadow&&this.attachShadow({mode:this.shadow}),this.forceRender(),this.connected&&this.connected(this)}setState(state,callback){let newState={...this.state,...state};JSON.stringify(newState)!=JSON.stringify(this.state)&&(this.state=newState,this.forceRender(callback))}forceRender(callback){if(this.pure)this.shadow?this.shadowRoot.innerHTML="shadow not supported in pure component":(this.innerHTML="",this.insertAdjacentHTML("afterbegin",this.render()));else{let html=this.render().trim();html=html.replace(/\s+/gi," "),html=html.replace(/<!--(.*?)-->/g,""),html=html.replace(new RegExp("&","g"),"&amp"),html=html.replace(new RegExp("> <","g"),"><");let newNode=this.parser.parseFromString(html,"text/xml").firstChild;this.shadow?(this.shadowRoot.append(""),this.draw(newNode,0,null,this.shadowRoot)):this.draw(newNode,0,null,this)}this.processRefs(this,this.refs,"ref"),this.binAll(this),callback&&callback()}draw(newNode,newNodeIndex,newNodeParent,realParentNode){let realNode=realParentNode.childNodes[newNodeIndex];if(realNode){if(newNode&&realNode.nodeName.toUpperCase()==newNode.nodeName.toUpperCase()){if(3==newNode.nodeType&&realNode.nodeValue!=newNode.nodeValue)return void(realNode.nodeValue=newNode.nodeValue);if(1==newNode.nodeType){let realKey=realNode.getAttribute("key"),newKey=newNode.getAttribute("key");if(newKey&&realKey!=newKey)if(realParentNode.childNodes.length<newNodeParent.childNodes.length){let newRealNode=document.createElement(newNode.nodeName);realNode.insertAdjacentElement("beforebegin",newRealNode),realNode=newRealNode}else if(realParentNode.childNodes.length>newNodeParent.childNodes.length){let nextNode=realNode.nextSibling;realParentNode.removeChild(realNode),realNode=nextNode}}}else if(newNode&&realNode.nodeName!=newNode.nodeName.toUpperCase()){if(3==newNode.nodeType)return void realParentNode.insertBefore(newNode,realNode);if(1==newNode.nodeType){let newRealNode=document.createElement(newNode.nodeName);realParentNode.insertBefore(newRealNode,realNode),realNode=newRealNode}}}else{if(newNode&&3==newNode.nodeType)return void realParentNode.insertAdjacentText("beforeend",newNode.nodeValue);newNode&&(realNode=document.createElement(newNode.nodeName),realParentNode.insertAdjacentElement("beforeend",realNode))}if(this.setAttributes(realNode,newNode),newNode&&-1!=newNode.nodeName.indexOf("-"))return;let i=0,length=newNode?newNode.childNodes.length:0;for(;i<length;)this.draw(newNode.childNodes[i],i,newNode,realNode),i++;if(newNode)for(;realNode.childNodes.length>length;)realNode.removeChild(realNode.childNodes[newNode.childNodes.length])}setAttributes(element,newDomMap){if(element&&1==element.nodeType&&newDomMap&&null!=newDomMap.attributes){let i=0,length=newDomMap.attributes.length;for(;i<length;){let name=newDomMap.attributes[i].nodeName,value=newDomMap.attributes[i].nodeValue,oldValue=element.attributes[name];if("value"==name&&element.value)element.value=value;else if(value){if(oldValue!=value)if(eventAttr[name])if(-1!=value.indexOf("=>"))element[name]=eval(value);else{let functionName=value.replace("this.",""),paramsStartAt=functionName.indexOf("(");if(-1==paramsStartAt)element[name]=this[functionName].bind(this);else{let params=functionName.slice(paramsStartAt+1,functionName.indexOf(")"));params=params.split(","),params=params.map(param=>param.trim()),functionName=functionName.slice(0,paramsStartAt),element[name]=()=>this[functionName](...params)}}else element.setAttribute(name,value)}else element.removeAttribute(name);i++}}}setData(name,opts){this.cuppa&&this.cuppa.setData(name,opts)}getData(name,opts){if(this.cuppa)return opts&&opts.callback?(this.cuppa.getData(name,opts),void(this.getDataDictionary[name]=opts)):this.cuppa.getData(name,opts)}removeData(){this.cuppa&&Object.entries(this.getDataDictionary).map(([key,value])=>{value&&value.callback&&this.cuppa.removeListener(key,value.callback),delete this.getDataDictionary[key]})}destroy(){this.removeData()}disconnectedCallback(){this.destroy&&this.destroy(),this.disconnected&&this.disconnected(this)}processRefs(html,addTo,tagAttr){tagAttr||(tagAttr="id");let nodes={},elements=Array.from(html.querySelectorAll(`[${tagAttr}]`));for(let i=0;i<elements.length;i++)addTo?addTo[elements[i].getAttribute(tagAttr)]=elements[i]:nodes[elements[i].getAttribute(tagAttr)]=elements[i];return addTo?addTo.rootHtml=html:nodes.rootHtml=html,nodes}binAll(element,isFunction){let propertyNames=Object.getOwnPropertyNames(Object.getPrototypeOf(element));isFunction&&(propertyNames=Object.keys(element));for(let i=0;i<propertyNames.length;i++)"function"==typeof element[propertyNames[i]]&&(element[propertyNames[i]]=element[propertyNames[i]].bind(element))}}